<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IU5 - Conferência de Carga (Expedição)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* A única regra que NÃO tem no styles.css é esta. 
           O resto pode apagar tudo. */
        .step-label {
            font-size: 11px;
            color: var(--cor-off);
            font-weight: 700;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            text-transform: uppercase;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
    </style>
</head>

<body>
    <input type="text" id="scannerTrap" class="scanner-trap" autocomplete="off" inputmode="none">

    <div class="mobile-mockup">
        <div class="status-bar-mockup">
            <span id="clock-mockup">11:05</span>
            <div style="display: flex; gap: 6px;">
                <i class="bi bi-wifi"></i>
                <i class="bi bi-battery-full"></i>
            </div>
        </div>

        <div class="app-screen-content">
            <div class="work-card" id="tela-principal">

                <div class="segmented-progress-wrapper">
                    <div class="segments-container" id="segmentsContainer">
                    </div>
                    <div class="progress-info">
                        <span class="step-name-display">Carga / Expedição</span>
                        <span class="step-counter">5/7</span>
                    </div>
                </div>

                <hr style="margin: 10px 0; border-top: 1px solid #eee;">

                <h4>Conferência de Carga</h4>
                <div style="font-size: 11px; color: var(--cor-off); margin-bottom: 15px;">
                    1) Iniciar · 2) Crachá · 3) Palete · 4) Itens
                </div>

                <div style="margin: 10px 0 20px 0; display: flex; gap: 8px; flex-wrap: wrap;">
                    <span class="status-pill" id="pillCracha">Crachá pendente</span>
                    <span class="status-pill" id="pillPalete">Palete pendente</span>
                    <span class="status-pill" id="pillItens" style="display:none;">0/0 Itens</span>
                </div>

                <div id="msgErro" class="msg-erro">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <span id="txtErro">Erro</span>
                </div>

                <div class="action-buttons-grid" id="opcoesEntrada">
                    <div class="btn-action-mode active" onclick="setOpMode('camera', this)">
                        <i class="bi bi-camera"></i>
                        <span>Câmera</span>
                    </div>
                    <div class="btn-action-mode" onclick="setOpMode('digitar', this)">
                        <i class="bi bi-keyboard"></i>
                        <span>Digitar</span>
                    </div>
                    <div class="btn-action-mode" onclick="setOpMode('leitor', this)">
                        <i class="bi bi-upc-scan"></i>
                        <span>Leitor</span>
                    </div>
                </div>

                <div id="step-start">
                    <button class="btn-green-block" id="btn-iu5-start" onclick="avancarEtapa('CRACHA')">
                        Iniciar Conf. Expedição
                    </button>
                </div>

                <div id="main-flow-container" style="margin-top: 20px;">

                    <div style="margin-bottom: 12px; position: relative;">
                        <div id="lblResp" class="step-label">
                            1. Responsável
                        </div>
                    </div>

                    <div style="margin-bottom: 12px; position: relative;">
                        <div id="lblPalete" class="step-label">
                            2. Palete
                        </div>
                    </div>

                    <div id="area-items" style="display: none;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 5px; margin-top: 20px;">
                            <div style="font-size: 11px; font-weight: 700; color: #555; margin:0;">CAIXAS NO PALETE
                            </div>
                            <span class="step-name-display" style="color:var(--cor-secundaria);"
                                id="iu5-box-count">0/0</span>
                        </div>

                        <div class="dashed-area" id="iu5-box-queue"
                            style="min-height: 100px; max-height: 200px; overflow-y: auto;">
                            <div
                                style="text-align: center; color: #999; font-size: 12px; margin-top: 30px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                <i class="bi bi-upc-scan" style="font-size:24px;"></i>
                                <span>Aguardando leitura do palete...</span>
                            </div>
                        </div>
                    </div>

                </div>

                <div id="final-actions" style="margin-top: 25px; display: none; gap: 10px; display: flex;">
                    <button class="btn-white-big" id="btn-finalizar-conf" onclick="finalizarConferencia()" disabled
                        style="flex: 1; margin: 0;">
                        Finalizar Conf.
                    </button>
                    <button class="btn-green-block" id="btn-carga-pronta" onclick="finalizarConferencia()" disabled
                        style="flex: 1; margin: 0; padding: 12px; font-size: 15px;">
                        Carga Pronta
                    </button>
                </div>

                <button class="btn-outline-red" id="btn-voltar-status" disabled
                    onclick="alert('Funcionalidade de estorno')">
                    Voltar status Preparação do Palete
                </button>

            </div>

            <div id="tela-sucesso" class="work-card" style="display: none;">
                <div class="success-internal-container"
                    style="display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding-top: 40px;">
                    <div
                        style="width: 100px; height: 100px; background: var(--cor-principal); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(39, 174, 97, 0.3);">
                        <i class="bi bi-check-lg" style="font-size: 50px; color: white;"></i>
                    </div>

                    <h4 style="margin-bottom: 5px; color: #2c3e50;">Expedição Liberada!</h4>
                    <p style="font-size: 14px; color: var(--cor-off); margin-bottom: 25px;">
                        Palete conferido e liberado para transporte.
                    </p>

                    <div
                        style="background: var(--cor-bg-item); border: 1px solid var(--cor-borda); padding: 20px; width: 90%; max-width: 400px; border-radius: 12px; text-align: left; margin-bottom: 25px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--cor-off); font-size: 14px;">Palete</span>
                            <strong id="resumoPalete" style="color: #333;">-</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--cor-off); font-size: 14px;">Itens</span>
                            <strong id="resumoItens" style="color: #333;">-</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--cor-off); font-size: 14px;">Responsável</span>
                            <strong id="resumoResp" style="color: var(--cor-principal);">JOÃO SILVA</strong>
                        </div>
                    </div>

                    <button class="btn-white-big" onclick="window.location.reload()">Próximo Palete</button>
                </div>
            </div>

        </div>

        <div id="bottomSheet" class="bottom-sheet-overlay">
            <div class="bottom-sheet">
                <span style="font-size: 14px; font-weight: 700; color: #333; display: block; margin-bottom: 12px;">
                    Digite o código
                </span>
                <input type="text" id="bsInput" class="bs-input" autocomplete="off" placeholder="..."
                    style="font-size: 15px; text-transform: uppercase;">
                <button class="btn-green-block" onclick="confirmarDigitacao()" style="margin-top: 5px;">OK</button>
            </div>
        </div>
    </div>

    <script>
        // --- AUDIO ---
        const audioSuccess = new Audio("audio/beep.mp3");
        const audioError = new Audio("audio/erro.mp3");
        function playSound(type) {
            try {
                if (type === 'success') {
                    audioSuccess.currentTime = 0;
                    audioSuccess.play().catch(() => console.log('Autoplay blocked'));
                } else if (type === 'error') {
                    audioError.currentTime = 0;
                    audioError.play().catch(() => console.log('Autoplay blocked'));
                }
            } catch (e) {
                console.error("Erro ao tocar áudio", e);
            }
        }

        // --- ESTADO ---
        const STEPS = {
            IDLE: 0,
            WAITING_CRACHA: 1,
            WAITING_PALETE: 2,
            FINISHED: 3
        };
        let currentStep = STEPS.IDLE;
        let modoDigitacaoAtivo = false;
        let responsavelLido = "";

        // Mock Data
        const MOCK_PALETE_ITENS = [
            { id: 'CX-99201', desc: 'Caixa Mista A' },
            { id: 'CX-99202', desc: 'Caixa Eletrônicos' },
            { id: 'CX-99203', desc: 'Kit Promocional' },
            { id: 'CX-99204', desc: 'Peças Soltas' }
        ];

        // ELEMENTOS DOM
        const scannerTrap = document.getElementById('scannerTrap');
        const bottomSheet = document.getElementById('bottomSheet');
        const bsInput = document.getElementById('bsInput');
        const pillCracha = document.getElementById('pillCracha');
        const pillPalete = document.getElementById('pillPalete');
        const pillItens = document.getElementById('pillItens');

        // --- INIT ---
        window.onload = () => {
            renderProgress();
            updateClock();
            setInterval(updateClock, 1000);
            focarScanner();
        };

        function updateClock() {
            const now = new Date();
            document.getElementById('clock-mockup').innerText =
                String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');
        }

        function renderProgress() {
            const container = document.getElementById('segmentsContainer');
            const etapas = 7; // agora são 7 etapas
            container.innerHTML = '';
            for (let i = 0; i < etapas; i++) {
                const seg = document.createElement('div');
                seg.classList.add('segment');
                if (i < 4) seg.classList.add('completed'); // etapas já concluídas
                else if (i === 4) seg.classList.add('active'); // etapa atual
                container.appendChild(seg);
            }
        }


        function focarScanner() {
            if (!modoDigitacaoAtivo && currentStep !== STEPS.FINISHED) {
                scannerTrap.focus();
            }
        }

        // --- FLUXO LÓGICO ---
        function avancarEtapa(target) {
            if (target === 'CRACHA') {
                currentStep = STEPS.WAITING_CRACHA;
                document.getElementById('btn-iu5-start').style.display = 'none';
                document.getElementById('final-actions').style.display = 'flex';
                focarScanner();
            }
        }

        // --- PROCESSAMENTO DE LEITURA ---
        scannerTrap.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const val = scannerTrap.value.trim().toUpperCase();
                scannerTrap.value = '';
                if (val) processarInput(val);
            }
        });

        function processarInput(codigo) {
            if (currentStep === STEPS.WAITING_CRACHA) {
                responsavelLido = codigo;

                // --- SUBSTITUIÇÃO HTML QUE MANTÉM A CLASSE .step-label ---
                const lblResp = document.getElementById('lblResp');

                // O layout flexbox da classe .step-label cuidará do espaçamento (texto esquerda, ícone direita)
                lblResp.innerHTML =
                    `1. RESPONSÁVEL: <span style="color:var(--cor-secundaria)">${codigo}</span> 
                     <i class="bi bi-check-circle-fill" style="color: var(--cor-principal);"></i>`;

                // Adiciona borda colorida para indicar sucesso/ativo
                lblResp.style.borderBottomColor = 'var(--cor-principal)';
                lblResp.style.borderBottomWidth = '2px';
                lblResp.style.opacity = '1';

                // Atualiza pill
                pillCracha.classList.add('check');
                pillCracha.innerText = "Crachá OK";

                // Avança para Palete
                currentStep = STEPS.WAITING_PALETE;

                document.getElementById('area-items').style.display = 'block';
                playSound('success');

            } else if (currentStep === STEPS.WAITING_PALETE) {
                if (codigo.length < 3) {
                    mostrarErro("Código de palete inválido");
                    return;
                }

                // --- SUBSTITUIÇÃO HTML PALETE ---
                const lblPalete = document.getElementById('lblPalete');

                lblPalete.innerHTML =
                    `2. PALETE: <span style="color:var(--cor-secundaria)">${codigo}</span> 
                     <i class="bi bi-check-circle-fill" style="color: var(--cor-principal);"></i>`;

                lblPalete.style.borderBottomColor = 'var(--cor-principal)';
                lblPalete.style.borderBottomWidth = '2px';
                lblPalete.style.opacity = '1';

                // Atualiza pill e itens
                pillPalete.classList.add('check');
                pillPalete.innerText = "Palete OK";

                pillItens.style.display = 'inline-block';
                pillItens.classList.add('check');
                pillItens.innerText = `${MOCK_PALETE_ITENS.length}/${MOCK_PALETE_ITENS.length} Itens`;

                carregarItens(codigo);

                document.getElementById('btn-finalizar-conf').disabled = false;
                document.getElementById('btn-carga-pronta').disabled = false;
                document.getElementById('btn-voltar-status').disabled = false;

                document.getElementById('resumoPalete').innerText = codigo;
                document.getElementById('resumoItens').innerText = MOCK_PALETE_ITENS.length;

                playSound('success');
            }
        }

        function carregarItens(paleteId) {
            const queue = document.getElementById('iu5-box-queue');
            const counter = document.getElementById('iu5-box-count');

            queue.innerHTML = '';

            MOCK_PALETE_ITENS.forEach((item, index) => {
                setTimeout(() => {
                    const div = document.createElement('div');
                    div.style.background = '#fff';
                    div.style.border = '1px solid #e0e0e0';
                    div.style.borderRadius = '8px';
                    div.style.padding = '8px 12px';
                    div.style.marginBottom = '6px';
                    div.style.display = 'flex';
                    div.style.justifyContent = 'space-between';
                    div.style.alignItems = 'center';
                    div.style.fontSize = '13px';
                    div.style.animation = 'fadeIn 0.3s';

                    div.innerHTML = `
                        <div style="display:flex; gap:10px; align-items:center;">
                            <i class="bi bi-box-seam" style="color:var(--cor-secundaria)"></i>
                            <div>
                                <strong>${item.id}</strong>
                                <div style="font-size:10px; color:#999;">${item.desc}</div>
                            </div>
                        </div>
                        <i class="bi bi-check2" style="color:var(--cor-principal);"></i>
                    `;
                    queue.appendChild(div);
                    queue.scrollTop = queue.scrollHeight;
                }, index * 200);
            });

            counter.innerText = `${MOCK_PALETE_ITENS.length}/${MOCK_PALETE_ITENS.length}`;
        }

        function finalizarConferencia() {

            // Marca estado como finalizado
            currentStep = STEPS.FINISHED;

            // Troca de telas
            document.getElementById('tela-principal').style.display = 'none';
            document.getElementById('tela-sucesso').style.display = 'block';

            // Atualiza resumo
            document.getElementById('resumoResp').innerText = responsavelLido;

            playSound('success');
            console.log("Conferência de carga finalizada com sucesso");

            // ⏱️ Aguarda 2 segundos e avança para IU6 (Transporte / Rota)
            setTimeout(() => {
                window.location.href = 'iu6.html';
            }, 2000);
        }


        // --- UTILITÁRIOS UI ---
        function mostrarErro(msg) {
            const el = document.getElementById('msgErro');
            const txt = document.getElementById('txtErro');

            el.className = 'msg-erro erro-permissao';
            el.style.display = 'flex';
            txt.innerText = msg;

            setTimeout(() => { el.style.display = 'none'; }, 2500);
            playSound('error');
        }

        // --- INPUT MANUAL ---
        function setOpMode(mode, btn) {
            // Se ainda não iniciou a conferência, ignora tudo
            if (currentStep === STEPS.IDLE) {
                focarScanner();
                return;
            }

            // Remove estado ativo de todos
            document.querySelectorAll('.btn-action-mode')
                .forEach(b => b.classList.remove('active'));

            // Ativa o botão clicado
            if (btn) btn.classList.add('active');

            // Modo DIGITAR
            if (mode === 'digitar') {
                modoDigitacaoAtivo = true;

                const bs = document.getElementById('bottomSheet');
                const inp = document.getElementById('bsInput');

                bs.style.display = 'flex';

                if (currentStep === STEPS.WAITING_CRACHA) {
                    inp.placeholder = "Digite Crachá...";
                } else if (currentStep === STEPS.WAITING_PALETE) {
                    inp.placeholder = "Digite Palete...";
                } else {
                    inp.placeholder = "...";
                }

                setTimeout(() => inp.focus(), 150);

            } else {
                // Camera ou Leitor
                modoDigitacaoAtivo = false;
                focarScanner();
            }
        }


        function confirmarDigitacao() {
            const val = document.getElementById('bsInput').value.trim().toUpperCase();
            if (val) {
                document.getElementById('bottomSheet').style.display = 'none';
                modoDigitacaoAtivo = false;
                processarInput(val);
            }
        }

        document.getElementById('bottomSheet').addEventListener('click', (e) => {
            if (e.target.id === 'bottomSheet') {
                e.target.style.display = 'none';
                modoDigitacaoAtivo = false;
                focarScanner();
            }
        });
    </script>
</body>

</html>