<!DOCTYPE html>

<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IU3 - Conferência (Mobile)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css">
</head>

<body> <input type="text" id="scannerTrap" class="scanner-trap" autocomplete="off" inputmode="none">

    <div class="mobile-mockup">
        <div class="status-bar-mockup">
            <span id="clock-mockup">10:27</span>
            <div style="display: flex; gap: 6px;">
                <i class="bi bi-wifi"></i>
                <i class="bi bi-battery-full"></i>
            </div>
        </div>

        <div class="app-screen-content">
            <div class="work-card" id="tela-principal">
                <div class="segmented-progress-wrapper">
                    <div class="segments-container" id="segmentsContainer">
                    </div>
                    <div class="progress-info">
                        <span class="step-name-display" id="stepNameDisplay">Conferência</span>
                        <span class="step-counter" id="stepCounterDisplay">3/7</span>
                    </div>
                </div>

                <hr style="margin: 10px 0; border-top: 1px solid #eee;">

                <h4>Conferência de Itens</h4>

                <div style="margin: 10px 0 20px 0; display: flex; gap: 8px;">
                    <span class="status-pill" id="pillOS">O.S pendente</span>
                    <span class="status-pill" id="pillCracha">Crachá pendente</span>
                    <span class="status-pill" id="pillItens" style="display:none;">0/0 Itens</span>
                </div>

                <div id="msgErro" class="msg-erro">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <span id="txtErro">Erro</span>
                </div>

                <div class="action-buttons-grid" id="opcoesEntrada">
                    <div class="btn-action-mode active" onclick="setOpMode('camera', this)">
                        <i class="bi bi-camera"></i>
                        <span>Câmera</span>
                    </div>
                    <div class="btn-action-mode" onclick="setOpMode('digitar', this)">
                        <i class="bi bi-keyboard"></i>
                        <span>Digitar</span>
                    </div>
                    <div class="btn-action-mode" onclick="setOpMode('leitor', this)">
                        <i class="bi bi-upc-scan"></i>
                        <span>Leitor</span>
                    </div>
                </div>

                <div id="areaSetup">
                    <div id="areaLeitura" class="dashed-area"
                        style="min-height: 80px; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-top: 15px;">
                        <i class="bi bi-upc-scan" style="font-size: 24px; color: var(--cor-secundaria);"></i>
                        <span style="margin-top: 10px;">Aguardando leitura O.S...</span>
                    </div>

                    <button class="btn-white-big" id="btnIdentificar" onclick="identificarResponsavel()" disabled>
                        <i class="bi bi-person-badge"></i>
                        <span>Identificar Responsável</span>
                    </button>

                    <button class="btn-green-block" id="btnIniciar" onclick="iniciarConferencia()" disabled>
                        Iniciar Conferência
                    </button>
                </div>

                <div id="areaExecucao" style="display: none;">
                    <div class="list-header">
                        <span class="label-passo" style="font-size: 12px; margin: 0; font-weight: 700;">ITENS
                            ESPERADOS</span>
                        <span style="font-size: 11px; color: var(--cor-secundaria);" id="contadorItens">0/0</span>
                    </div>

                    <div class="dashed-area" id="containerLista">
                        <div id="listaConteudo" style="width: 100%;"></div>
                    </div>

                    <div
                        style="text-align: center; margin-top: 10px; color: #777; font-size: 12px; margin-bottom: 20px;">
                        <i class="bi bi-info-circle"></i> Bipe cada item para confirmar
                    </div>

                    <button class="btn-white-big" id="btnVoltar" onclick="voltarParaSetup()"
                        style="display: none; border-color: var(--cor-erro); color: var(--cor-erro);">
                        <i class="bi bi-arrow-counterclockwise"></i> Voltar
                    </button>

                    <button class="btn-white-big" id="btnFinalizar" onclick="verificarConferencia()">
                        Finalizar Conferência
                    </button>
                </div>
            </div>

            <div id="tela-sucesso" class="work-card" style="display: none;">
                <div class="success-internal-container" style="display: flex;">
                    <div
                        style="width: 100px; height: 100px; background: var(--cor-principal); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(39, 174, 97, 0.3);">
                        <i class="bi bi-check-lg" style="font-size: 50px; color: white;"></i>
                    </div>

                    <h4 style="margin-bottom: 5px; font-size: 22px; color: #2c3e50;">Conferência OK!</h4>
                    <p style="font-size: 14px; color: var(--cor-off); margin-bottom: 25px;">
                        Todos os itens foram validados com sucesso. Status Interno: <b>Conferido</b>.
                    </p>

                    <div
                        style="background: var(--cor-bg-item); border: 1px solid var(--cor-borda); padding: 20px; width: 90%; max-width: 400px; border-radius: 12px; text-align: left; margin-bottom: 25px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--cor-off); font-size: 14px;">O.S</span>
                            <strong id="resumoOS" style="color: #333;">-</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--cor-off); font-size: 14px;">Itens</span>
                            <strong id="resumoItens" style="color: #333;">0</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--cor-off); font-size: 14px;">Responsável</span>
                            <strong id="resumoResponsavel" style="color: var(--cor-principal);">-</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="bottomSheet" class="bottom-sheet-overlay">
            <div class="bottom-sheet">
                <span style="font-size: 14px; font-weight: 700; color: #333; display: block; margin-bottom: 12px;">
                    Digite o código
                </span>
                <input type="text" id="bsInput" class="bs-input" autocomplete="off" placeholder="..."
                    style="font-size: 15px; text-transform: uppercase;">
                <button class="btn-green-block" onclick="confirmarDigitacao()" style="margin-top: 5px;">OK</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO DE ÁUDIO ---
        const audioSuccess = new Audio("audio/beep.mp3");
        const audioError = new Audio("audio/erro.mp3");

        function playSound(type) {
            try {
                if (type === 'success') {
                    audioSuccess.currentTime = 0;
                    audioSuccess.play().catch(() => console.log('Autoplay blocked'));
                } else if (type === 'error') {
                    audioError.currentTime = 0;
                    audioError.play().catch(() => console.log('Autoplay blocked'));
                }
            } catch (e) {
                console.error("Erro ao tocar áudio", e);
            }
        }

        // --- DADOS MOCKADOS (IU3) ---
        const MOCK_ITENS_OS = [
            { id: 'CB00305G10000002SOS', nome: 'Caixa Box', icon: 'bi-box-seam', status: false },
            { id: 'CX0012000000011SOS', nome: 'Caixa 20kg', icon: 'bi-box-seam-fill', status: false },
            { id: 'DC00120A0018854SOS', nome: 'Documentos', icon: 'bi-file-earmark-text', status: false }
        ];

        // --- ESTADO GLOBAL ---
        let currentStep = 'setup'; // 'setup', 'conferencia', 'success'
        let osBipada = null;
        let responsavel = null;
        let modoDigitacaoAtivo = false;
        let itensConferidos = 0;

        const etapas = [
            "Atribuição",
            "Separação",
            "Conferência",
            "Paletização",
            "Carga",
            "Transporte",
            "Entrega"
        ];

        // ELEMENTOS DOM
        const scannerTrap = document.getElementById('scannerTrap');
        const bottomSheet = document.getElementById('bottomSheet');
        const bsInput = document.getElementById('bsInput');

        const pillOS = document.getElementById('pillOS');
        const pillCracha = document.getElementById('pillCracha');
        const pillItens = document.getElementById('pillItens');

        const areaSetup = document.getElementById('areaSetup');
        const areaLeitura = document.getElementById('areaLeitura');
        const areaExecucao = document.getElementById('areaExecucao');

        const btnIdentificar = document.getElementById('btnIdentificar');
        const btnIniciar = document.getElementById('btnIniciar');
        const btnFinalizar = document.getElementById('btnFinalizar');
        const btnVoltar = document.getElementById('btnVoltar');

        const listaConteudo = document.getElementById('listaConteudo');
        const contadorItens = document.getElementById('contadorItens');

        // INICIALIZAÇÃO
        window.onload = () => {
            updateClockMockup();
            setInterval(updateClockMockup, 1000);
            renderProgress();
            focarScanner();
        };

        function updateClockMockup() {
            const now = new Date();
            document.getElementById('clock-mockup').innerText =
                String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');
        }

        function renderProgress() {
            const container = document.getElementById('segmentsContainer');
            container.innerHTML = '';
            etapas.forEach((_, index) => {
                const seg = document.createElement('div');
                seg.classList.add('segment');
                if (index < 2) seg.classList.add('completed');
                else if (index === 2) seg.classList.add('active');
                container.appendChild(seg);
            });
        }



        // --- CAPTURA DE LEITURA (SCANNER TRAP) ---
        scannerTrap.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const val = scannerTrap.value.trim().toUpperCase();
                scannerTrap.value = '';
                if (!val) return;
                processarLeitura(val);
            }
        });

        function focarScanner() {
            if (!modoDigitacaoAtivo && currentStep !== 'success') {
                scannerTrap.focus();
            }
        }

        // --- LÓGICA DE PROCESSAMENTO ---
        function processarLeitura(codigo) {
            if (currentStep === 'setup') {
                handleSetupLeitura(codigo);
            } else if (currentStep === 'conferencia') {
                handleItemLeitura(codigo);
            }
        }

        // STEP 1: SETUP (LER O.S)
        function handleSetupLeitura(codigo) {
            if (osBipada) {
                mostrarErro("O.S já identificada");
                return;
            }

            // Simulação de validação de formato
            if (codigo.length < 5) {
                mostrarErro("Código O.S inválido");
                playSound('error');
                return;
            }

            osBipada = codigo;
            pillOS.classList.add('check');
            pillOS.innerText = "O.S Confirmada";

            areaLeitura.style.display = 'none'; // Some a caixa de leitura

            // Habilita identificar responsável
            btnIdentificar.disabled = false;

            playSound('success');
            focarScanner();
        }

        // IDENTIFICAR RESPONSÁVEL
        function identificarResponsavel() {
            if (!osBipada) return;

            const operadores = ["JOÃO SILVA", "MARIA OLIVEIRA", "CARLOS SOUZA"];
            responsavel = operadores[Math.floor(Math.random() * operadores.length)];

            pillCracha.classList.add('check');
            pillCracha.innerText = `Crachá OK`;

            btnIdentificar.classList.add('active-scan');
            btnIdentificar.innerHTML = `<i class="bi bi-check-circle-fill"></i> ${responsavel}`;

            btnIniciar.disabled = false;
            playSound('success');
        }

        // INICIAR CONFERÊNCIA
        function iniciarConferencia() {
            if (!osBipada || !responsavel) return;

            currentStep = 'conferencia';
            areaSetup.style.display = 'none';
            areaExecucao.style.display = 'block';
            pillItens.style.display = 'inline-block';
            pillItens.innerText = `0/${MOCK_ITENS_OS.length} Itens`;

            // Renderiza lista inicial
            renderizarListaItens();
            focarScanner();
        }

        function renderizarListaItens() {
            let html = '';
            MOCK_ITENS_OS.forEach(item => {
                const checkedClass = item.status ? 'checked' : '';
                const iconStatus = item.status ? 'bi-check-circle-fill' : 'bi-circle';

                html += `
                <div class="os-item ${checkedClass}" id="row-${item.id}">
                    <div class="os-left">
                        <i class="bi ${item.icon} item-icon"></i>
                        <div class="os-caixa">
                            <span>${item.nome}</span>
                            <span class="os-subtext">${item.id}</span>
                        </div>
                    </div>
                    <i class="bi ${iconStatus} status-icon" id="icon-${item.id}"></i>
                </div>
            `;
            });
            listaConteudo.innerHTML = html;
            contadorItens.innerText = `${itensConferidos}/${MOCK_ITENS_OS.length}`;
        }

        // STEP 2: CONFERÊNCIA (LER ITEM)
        function handleItemLeitura(codigo) {
            const item = MOCK_ITENS_OS.find(i => i.id === codigo);

            if (!item) {
                mostrarErro("Item não pertence à O.S");
                playSound('error');
                return;
            }

            if (item.status) {
                mostrarErro("Item já conferido");
                return; // Não dá erro sonoro, apenas aviso
            }

            // Atualiza estado
            item.status = true;
            itensConferidos++;

            // Atualiza UI
            renderizarListaItens();
            pillItens.innerText = `${itensConferidos}/${MOCK_ITENS_OS.length} Itens`;
            playSound('success');

            // Scroll para o item (opcional, simples aqui)

            // Verifica se acabou
            if (itensConferidos === MOCK_ITENS_OS.length) {
                btnFinalizar.classList.remove('btn-white-big');
                btnFinalizar.classList.add('btn-green-block');
                btnFinalizar.innerText = "Concluir Conferência";

                // Remove erros visuais caso existam
                document.querySelectorAll('.os-item').forEach(el => el.classList.remove('erro'));
                document.getElementById('msgErro').style.display = 'none';
                btnVoltar.style.display = 'none';
            }
        }

        function verificarConferencia() {
            if (itensConferidos < MOCK_ITENS_OS.length) {
                // Erro: Itens pendentes
                mostrarErro("MSG3: Alguns itens não foram bipados.");
                playSound('error');

                // Marcar itens não bipados com erro visual
                MOCK_ITENS_OS.forEach(item => {
                    if (!item.status) {
                        const row = document.getElementById(`row-${item.id}`);
                        if (row) {
                            row.classList.add('erro');
                            const icon = document.getElementById(`icon-${item.id}`);
                            icon.classList.remove('bi-circle');
                            icon.classList.add('bi-x-circle-fill');
                        }
                    }
                });

                btnVoltar.style.display = 'block';
                return;
            }

            // Sucesso
            finalizarProcesso();
        }

        function voltarParaSetup() {
            // Recarrega "virtualmente" a lista limpa visualmente (mantém estado ou reseta?)
            // Reseta visual dos erros
            renderizarListaItens();
            btnVoltar.style.display = 'none';
            focarScanner();
        }

        function finalizarProcesso() {
            currentStep = 'success';

            // Troca de telas
            document.getElementById('tela-principal').style.display = 'none';
            document.getElementById('tela-sucesso').style.display = 'block';

            // Preenche resumo
            document.getElementById('resumoOS').innerText = osBipada;
            document.getElementById('resumoItens').innerText = itensConferidos;
            document.getElementById('resumoResponsavel').innerText = responsavel;

            playSound('success');

            // ⏱️ Aguarda 2 segundos e segue o fluxo → IU4
            setTimeout(() => {
                window.location.href = 'iu4.html';
            }, 2000);
        }


        // --- UTILITÁRIOS UI ---
        function mostrarErro(msg) {
            const el = document.getElementById('msgErro');
            const txt = document.getElementById('txtErro');

            el.className = 'msg-erro erro-permissao';
            el.style.display = 'flex';
            txt.innerText = msg;

            setTimeout(() => { el.style.display = 'none'; }, 3000);
        }

        function setOpMode(mode, btn) {
            document.querySelectorAll('#opcoesEntrada .btn-action-mode').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            if (mode === 'digitar') {
                ativarInputManual();
            } else if (mode === 'camera') {
                alert("Módulo de câmera acionado");
                focarScanner();
            } else {
                focarScanner();
            }
        }

        function ativarInputManual() {
            if (currentStep === 'success') return;
            modoDigitacaoAtivo = true;
            bottomSheet.style.display = 'flex';
            bsInput.value = '';

            let placeholder = "...";
            if (currentStep === 'setup') placeholder = "Digite a O.S...";
            if (currentStep === 'conferencia') placeholder = "Digite cód. do item...";

            bsInput.placeholder = placeholder;
            setTimeout(() => bsInput.focus(), 150);
        }

        function confirmarDigitacao() {
            const val = bsInput.value.trim().toUpperCase();
            if (!val) return;

            bottomSheet.style.display = 'none';
            modoDigitacaoAtivo = false;

            processarLeitura(val);
            focarScanner();
        }

        // EVENT LISTENERS
        bsInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') confirmarDigitacao();
        });

        bottomSheet.addEventListener('click', (e) => {
            if (e.target === bottomSheet) {
                bottomSheet.style.display = 'none';
                modoDigitacaoAtivo = false;
                focarScanner();
            }
        });
    </script>

</body>

</html>